{"meta":{"file_version":"4.0.2","database_name":"eleventhree","export_timestamp":"2023-08-07T19:15:48.641369+00:00","export_library_fqn":["brewing"],"database_schema_version":"4.5.17"},"types":[{"fqn":["brewing","plaatopro"],"scripts":[{"run":true,"owner":"cesmiihq","script":"<?php\r\n// Purpose: Get data from Plaato API\r\n//  This script assumes it is configured with a \"custom\" parameter that defines the API key like:\r\n//  {\"apikey\":\"YOURPLAATOAPIKEY\"}\r\nuse \\TiqUtilities\\Model\\Node;\r\nuse \\TiqUtilities\\Model\\Attribute;\r\n\r\nrequire_once 'thinkiq_context.php';\r\n$context = new Context();\r\n$apikey = $context->custom_inputs->apikey;\r\n\r\n// Make or find the target attributes to be updated\r\n$parent = new Node($context->std_inputs->node_id);\r\n$this_plaato = strtolower($parent->display_name);\r\necho \"Updating: \" . $this_plaato . \"\\r\\n\";\r\n$parent->getAttributes();\r\n\r\n$this_data = getParsedPlaatoData($this_plaato, $apikey);\r\nif ($this_data == null) {\r\n    echo(\"Could not find data from Plaato API that matches this device name!\");\r\n} else {\r\n    echo \"Found data for: \" . $this_plaato . \"\\r\\n\";\r\n    \r\n    //Make time. TODO: Use device timestamp\r\n    $the_time = $this_data->latestReading->time;\r\n    echo \"Device time: \" . $the_time . \"\\r\\n\";\r\n    $current_time_with_millisecond = DateTime::createFromFormat('U.u', microtime(true))->format(DateTimeInterface::RFC3339_EXTENDED);\r\n    $times = [$current_time_with_millisecond];\r\n    echo \"Using Time: \" . $times[0] . \"\\r\\n\";\r\n\r\n    echo \"\\r\\nActions:\\r\\n\";\r\n    $attribs = $parent->attributes;\r\n    foreach($attribs as $attrib){\r\n        $desc = $attrib->description;\r\n        $values = [];\r\n        if ($desc != \"\") {\r\n            $descParts = explode(\"\\\\\", $desc);\r\n            $the_value = getProperty($this_data, $descParts);\r\n            echo \"- Need to update \" . $attrib->relative_name . \" of type: \" . $attrib->data_type . \", from datasource: \" . $desc;\r\n            echo \", with value: \" . $the_value . \" \\r\\n\";\r\n            array_push($values, $the_value);\r\n            if ($attrib->data_type == \"float\")\r\n                $attrib->insertTimeSeries($values, $times);\r\n            elseif ($attrib->data_type == \"string\") {\r\n                $attrib->string_value = $values[0];\r\n                $attrib->save();\r\n            }\r\n            elseif ($attrib->data_type == \"bool\") {\r\n                if (isset($values[0]) && boolval($values[0]) == true) {\r\n                    $attrib->string_value = boolval($values[0]);\r\n                    $attrib->save();\r\n                }\r\n            }\r\n        }\r\n    }\r\n    //echo json_encode($parent->attributes, JSON_PRETTY_PRINT) . \"\\r\\n\";\r\n}\r\n\r\necho \"\\r\\nCompleted update at \" . $times[0];\r\n$context->return_data();\r\n\r\nfunction getProperty($obj, $property) {\r\n  foreach( $property as $p ) {\r\n     $obj = $obj->{$p};\r\n   }\r\n   return $obj;\r\n}\r\n\r\nfunction getParsedPlaatoData($this_plaato, $apikey) {\r\n    $response = getPlaatoData($apikey);\r\n    $jsonArray = json_decode($response);\r\n    foreach($jsonArray as $value){\r\n        $curr_plaato = strtolower($value->name);\r\n        if ($this_plaato == $curr_plaato)\r\n            return $value;\r\n    }\r\n}\r\n\r\nfunction getPlaatoData($apikey) {\r\n    $ch = curl_init();\r\n    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);\r\n    curl_setopt($ch, CURLOPT_URL, 'https://api.plaato.cloud/devices');\r\n    curl_setopt($ch, CURLOPT_HTTPHEADER, [\r\n        'x-plaato-api-key: ' . $apikey\r\n    ]);\r\n    $response = curl_exec($ch);\r\n    if(curl_error($ch)) {\r\n        fwrite($fp, curl_error($ch));\r\n    }\r\n    curl_close($ch);\r\n    return $response;\r\n}","document":{"template":false},"description":null,"edit_status":1,"output_type":"headless","script_type":"php","display_name":"ImportFromPlaatoAPI","relative_name":"importfromplaatoapi","initial_inputs":{"apikey":"YOURPLAATOAPIKEY","start_timestamp":"2023-08-07T18:14:05.000+00:00","interval_seconds":"60"},"cron_expression":"0 0/10 * * * ? *","exec_on_derived":false,"updated_timestamp":"2023-08-07T19:15:11.79389+00:00","max_acceptable_run_secs":0,"use_outputs_from_last_run":true}],"document":null,"attributes":[{"icon":null,"document":null,"data_type":"float","is_hidden":false,"max_value":100,"min_value":0,"expression":null,"importance":10,"description":"batteryLevel","edit_status":1,"is_required":false,"display_name":"Battery Level","default_value":null,"relative_name":"battery_level","decimal_places":2,"source_category":"dynamic","attribute_limits":[],"updated_timestamp":"2023-07-25T18:16:53.607793+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"linear","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":["thinkiq_base_library","percent"]},{"icon":null,"document":null,"data_type":"float","is_hidden":false,"max_value":100,"min_value":0,"expression":null,"importance":10,"description":"wifiStrength","edit_status":1,"is_required":false,"display_name":"WiFi Strength","default_value":null,"relative_name":"wifi_strength","decimal_places":2,"source_category":"dynamic","attribute_limits":[],"updated_timestamp":"2023-07-25T18:17:31.594735+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"linear","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":["thinkiq_base_library","percent"]},{"icon":null,"document":null,"data_type":"float","is_hidden":false,"max_value":null,"min_value":null,"expression":null,"importance":10,"description":"latestReading\\temperature\\celsius","edit_status":1,"is_required":false,"display_name":"Temperature C","default_value":null,"relative_name":"temperature_c","decimal_places":2,"source_category":"dynamic","attribute_limits":[],"updated_timestamp":"2023-07-25T18:18:34.678461+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"linear","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":["thinkiq_base_library","celsius"]},{"icon":null,"document":null,"data_type":"float","is_hidden":false,"max_value":null,"min_value":null,"expression":null,"importance":10,"description":"latestReading\\temperature\\fahrenheit","edit_status":1,"is_required":false,"display_name":"Temperature F","default_value":null,"relative_name":"temperature_f","decimal_places":2,"source_category":"dynamic","attribute_limits":[],"updated_timestamp":"2023-07-25T18:19:13.657108+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"linear","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":["thinkiq_base_library","fahrenheit"]},{"icon":null,"document":null,"data_type":"float","is_hidden":false,"max_value":null,"min_value":null,"expression":null,"importance":10,"description":"latestReading\\density\\specificGravity","edit_status":1,"is_required":false,"display_name":"Specific Gravity","default_value":null,"relative_name":"specific_gravity","decimal_places":2,"source_category":"dynamic","attribute_limits":[],"updated_timestamp":"2023-07-25T18:20:17.702165+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"linear","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":null},{"icon":null,"document":null,"data_type":"float","is_hidden":false,"max_value":null,"min_value":null,"expression":null,"importance":10,"description":"latestReading\\fermentationActivity\\mSgPerHour","edit_status":1,"is_required":false,"display_name":"mSg Per Hour","default_value":null,"relative_name":"msg_per_hour","decimal_places":2,"source_category":"dynamic","attribute_limits":[],"updated_timestamp":"2023-07-25T18:20:51.181047+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"linear","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":null},{"icon":null,"document":null,"data_type":"float","is_hidden":false,"max_value":null,"min_value":null,"expression":null,"importance":10,"description":"latestReading\\fermentationActivity\\pPerHour","edit_status":1,"is_required":false,"display_name":"p Per Hour","default_value":null,"relative_name":"p_per_hour","decimal_places":2,"source_category":"dynamic","attribute_limits":[],"updated_timestamp":"2023-07-25T18:21:19.918866+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"linear","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":null},{"icon":null,"document":null,"data_type":"string","is_hidden":false,"max_value":null,"min_value":null,"expression":null,"importance":2,"description":"hardwareId","edit_status":1,"is_required":false,"display_name":"Hardware ID","default_value":null,"relative_name":"hardware_id","decimal_places":2,"source_category":"config","attribute_limits":[],"updated_timestamp":"2023-07-25T18:23:36.17022+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"previous","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":null},{"icon":null,"document":null,"data_type":"float","is_hidden":false,"max_value":null,"min_value":null,"expression":null,"importance":10,"description":"latestReading\\frequency","edit_status":1,"is_required":false,"display_name":"Frequency","default_value":null,"relative_name":"frequency_28590","decimal_places":2,"source_category":"dynamic","attribute_limits":[],"updated_timestamp":"2023-07-25T19:23:17.547384+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"linear","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":null},{"icon":null,"document":null,"data_type":"string","is_hidden":false,"max_value":null,"min_value":null,"expression":null,"importance":10,"description":"state","edit_status":1,"is_required":false,"display_name":"State","default_value":null,"relative_name":"state","decimal_places":2,"source_category":"config","attribute_limits":[],"updated_timestamp":"2023-07-26T14:20:42.499574+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"previous","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":null},{"icon":null,"document":null,"data_type":"bool","is_hidden":false,"max_value":null,"min_value":null,"expression":null,"importance":10,"description":"archived\\isArchived","edit_status":1,"is_required":false,"display_name":"Archived","default_value":null,"relative_name":"archived","decimal_places":2,"source_category":"config","attribute_limits":[],"updated_timestamp":"2023-07-26T14:20:46.880557+00:00","attribute_type_fqn":null,"enumeration_type_fqn":null,"interpolation_method":"previous","unlink_relative_name":false,"object_history_type_id":null,"default_enumeration_values":null,"default_measurement_unit_fqn":null}],"description":"<p><a href=\"https://eleventhree.thinkiq.net/images/th-2087594681.jpg\" class=\"jcepopup\" data-mediabox=\"1\"><img src=\"https://eleventhree.thinkiq.net/images/th-2087594681.jpg\" alt=\"th 2087594681\" width=\"474\" height=\"463\" /></a></p>","edit_status":1,"display_name":"PlaatoPro","opcua_methods":[],"relative_name":"plaatopro","classification":"equipment","child_equipment":[],"sub_type_of_fqn":["thinkiq_base_library","equipment"],"updated_timestamp":"2023-07-25T18:15:05.687178+00:00","unlink_relative_name":false},{"fqn":["thinkiq_base_library","equipment"],"scripts":[],"document":null,"attributes":[],"description":"Base type of equipment types.","edit_status":1,"display_name":"Equipment","opcua_methods":[],"relative_name":"equipment","classification":"equipment","child_equipment":[],"sub_type_of_fqn":null,"updated_timestamp":"2022-08-02T00:48:48.107651+00:00","unlink_relative_name":false}],"objects":[],"libraries":[{"fqn":["brewing"],"locked":false,"models":null,"aliases":null,"version":"1.0.0","document":null,"licensing":null,"extensions":null,"description":null,"edit_status":1,"server_uris":null,"display_name":"Brewing","relative_name":"brewing","namespace_uris":null,"updated_timestamp":"2023-07-20T15:26:13.507347+00:00","unlink_relative_name":false},{"fqn":["thinkiq_base_library"],"locked":true,"models":null,"aliases":null,"version":"1.7.0","document":null,"licensing":"The ThinkIQ Base Library is copyright protected.","extensions":null,"description":"ThinkIQ Base Library","edit_status":1,"server_uris":null,"display_name":"ThinkIQ Base Library","relative_name":"thinkiq_base_library","namespace_uris":null,"updated_timestamp":"2023-07-14T00:24:58.550789+00:00","unlink_relative_name":false}],"quantities":[{"fqn":["thinkiq_base_library","fraction_quantity"],"document":null,"description":"The ratio between two dimensionless numbers","edit_status":1,"display_name":"Fraction quantity","relative_name":"fraction_quantity","quantity_symbol":"Fraction","updated_timestamp":"2022-09-14T05:16:01.824244+00:00","unlink_relative_name":false},{"fqn":["thinkiq_base_library","temperature_quantity"],"document":null,"description":"The physical property of matter that quantitatively expresses the common notions of hot and cold","edit_status":1,"display_name":"Temperature quantity","relative_name":"temperature_quantity","quantity_symbol":"T","updated_timestamp":"2022-09-14T05:16:01.824244+00:00","unlink_relative_name":false}],"relationships":[],"attribute_types":[],"opcua_variables":[],"opcua_data_types":[],"script_templates":[],"enumeration_types":[],"measurement_units":[{"fqn":["thinkiq_base_library","celsius"],"symbol":"째C","document":null,"is_hidden":false,"unece_code":"CEL","unece_name":"degree Celsius","description":"A scale and unit of measurement for temperature. Also known as centigrade.","edit_status":1,"display_name":"째Celsius","quantity_fqn":["thinkiq_base_library","temperature_quantity"],"opcua_unit_id":4408652,"relative_name":"celsius","conversion_offset":273.15,"updated_timestamp":"2022-09-14T05:16:01.824244+00:00","unlink_relative_name":false,"conversion_multiplier":1},{"fqn":["thinkiq_base_library","fahrenheit"],"symbol":"째F","document":null,"is_hidden":false,"unece_code":"FAH","unece_name":"degree Fahrenheit","description":"A scale and unit of measurement for temperature, in which water freezes at 32 degrees and boils at 212 degrees.","edit_status":1,"display_name":"째Fahrenheit","quantity_fqn":["thinkiq_base_library","temperature_quantity"],"opcua_unit_id":4604232,"relative_name":"fahrenheit","conversion_offset":459.67,"updated_timestamp":"2022-09-14T05:16:01.824244+00:00","unlink_relative_name":false,"conversion_multiplier":0.55555556},{"fqn":["thinkiq_base_library","percent"],"symbol":"%","document":null,"is_hidden":false,"unece_code":"P1","unece_name":"percent","description":null,"edit_status":1,"display_name":"percent","quantity_fqn":["thinkiq_base_library","fraction_quantity"],"opcua_unit_id":20529,"relative_name":"percent","conversion_offset":0,"updated_timestamp":"2022-09-14T05:16:01.824244+00:00","unlink_relative_name":false,"conversion_multiplier":1}],"relationship_types":[],"opcua_variable_types":[],"opcua_reference_types":[],"md5_checksum":"d1ecb02de1152046d3be0fa41b123154"}